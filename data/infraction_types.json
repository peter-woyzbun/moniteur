[{"fields": {"resolved_email_template": "{{user_name}},\r\n<br><br>\r\n{{greeting}}! We have some good news. Your datasource {{object_name}} is no longer stale.\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "interval": 7, "enable_archive": "False", "description": "A datasource that has not been viewed in more than 30 days.", "email_template": "{{user_name}},\r\n<br><br>\r\n{{greeting}}! We have some news. It looks like one or more of your Tableau datasources have not been accessed in over 30 days - FYI! You can find more detail below. If a connection is no longer needed/used, consider removing it from the server (to keep the server running fast and to avoid confusion with users). Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b></li>\r\n<ul><li>Last accessed: {{ infraction.infraction_value}} days ago</li></ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)\r\n\r\n", "infraction_type": "Stale datasource", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "SELECT\r\n    -- object info\r\n    ds.id AS object_id,\r\n    ds.luid,\r\n    ds.name AS object_name,\r\n    'Datasource' AS object_type,\r\n    -- user info\r\n    ds.owner_id AS user_id,\r\n    su.name AS user_name,\r\n    su.email AS user_email,\r\n    su.friendly_name AS user_friendly_name,\r\n    -- infraction info\r\n    ds.extracts_refreshed_at AS last_extract_refresh,\r\n    DATE_PART('days', timezone('UTC', NOW()) - ds.extracts_refreshed_at) AS infraction_value,\r\n    timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n    timezone('UTC', CURRENT_TIMESTAMP) AS review_by\r\nFROM public.datasources ds\r\nJOIN public._system_users su ON su.id = ds.owner_id\r\nWHERE ds.data_engine_extracts = True\r\n    AND ds.first_published_at < timezone('UTC', NOW()) - INTERVAL '30 days'\r\n    AND ds.extracts_refreshed_at < timezone('UTC', NOW()) - INTERVAL '30 days'\r\n    AND su.email IS NOT NULL\r\n    -- ?? query ds.extracts_incremented_at as well ??\r\nLIMIT 5", "archive_notice_template": "t"}, "model": "schema.infractiontype", "pk": 1}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "When an object has more than 300 extract refreshes per day from the same user (automated extract refresh abuse).", "email_template": "Template", "infraction_type": "Automated refreshes", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Archive warning template", "search_query": "SELECT bt2.title, bt2.subtitle, extract_date, a.extract_count,\r\n    COALESCE(ds.owner_name,wb.owner_name) AS user_name,\r\n    bt2.job_name\r\nFROM public._background_tasks bt2\r\nLEFT OUTER JOIN _datasources ds ON ds.name = bt2.title\r\nLEFT OUTER JOIN _workbooks wb ON wb.name = bt2.title\r\nRIGHT JOIN\r\n    (\r\n    SELECT bt1.title, DATE(bt1.started_at) AS extract_date, COUNT(bt1.title) AS extract_count\r\n    FROM public._background_tasks bt1\r\n    GROUP BY bt1.title, extract_date\r\n    ) AS a\r\nON a.title = bt2.title\r\nWHERE a.extract_date > DATE(NOW()) - INTERVAL '14 days' AND (bt2.job_name = 'Refresh Extracts' OR bt2.job_name = 'Increment Extracts') AND a.extract_count > 300\r\nLIMIT 500", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 2}, {"fields": {"resolved_email_template": "{{user_friendly_name}},\r\n<br><br>\r\n{{greeting}}! We have some good news. Your workbook {{object_name}} is no longer stale.\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "interval": 3, "enable_archive": "True", "description": "A workbook that has not been viewed in more than 30 days.", "email_template": "{{user_name}},\r\n<br><br>\r\n{{greeting}}! We have some news. It looks like one or more of your Tableau datasources have not been accessed in over 30 days - FYI! You can find more detail below. If a connection is no longer needed/used, consider removing it from the server (to keep the server running fast and to avoid confusion with users). Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b></li>\r\n<ul><li>Last accessed: {{ infraction.infraction_value}} days ago</li></ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "infraction_type": "Stale workbook", "email_count": 3, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "{{user_friendly_name}},\r\n<br><br>\r\n{{greeting}}! Your workbook, <b>{{object_name}}</b>, has not been accessed for {{infraction_value}} days. If the workbook is no longer needed/used, please consider removing it from the server (to keep the server running fast and to avoid confusion with users). \r\n<br><br>\r\nIf the workbook remains unused by {{archive_date}}, it will be automatically archived.\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "search_query": "SELECT \r\n    -- object info\r\n    wb.id AS object_id,\r\n    wb.luid AS luid,\r\n    wb.name AS object_name,\r\n    'Workbook' AS object_type,\r\n    -- user info\r\n    su.id as user_id,\r\n    su.name AS user_name,\r\n    su.friendly_name AS user_friendly_name,\r\n    su.email AS user_email,\r\n    -- infraction info\r\n    wv.last_view_time,\r\n    DATE_PART('days', DATE(NOW()) - wv.last_view_time) AS infraction_value,\r\n    timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n    timezone('UTC', CURRENT_TIMESTAMP) AS review_by\r\nFROM workbooks AS wb\r\nJOIN public._workbooks AS _wb ON _wb.id = wb.id\r\nLEFT JOIN (\r\n    -- aggregate last view time for each workbook\r\n    SELECT views_workbook_id, MAX(timezone('UTC', last_view_time)) as last_view_time\r\n    FROM public._views_stats \r\n    GROUP BY views_workbook_id\r\n     ) wv ON wv.views_workbook_id = wb.id\r\nJOIN public._system_users su ON su.id = wb.owner_id\r\nWHERE wb.created_at < timezone('UTC', NOW() - INTERVAL '30 days')\r\n    AND (wv.last_view_time IS NULL OR wv.last_view_time < DATE(NOW()) - INTERVAL '30 days')\r\n    AND su.email IS NOT NULL\r\nLIMIT 5", "archive_notice_template": "{{user_friendly_name}},\r\n<br><br>\r\n{{greeting}}! Your workbook, <b>{{object_name}}</b>, is being archived! You'll never see it again! We do this at random!\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)"}, "model": "schema.infractiontype", "pk": 3}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "A workbook that consistently takes longer than 30 seconds to load.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}} It looks like one or more of your workbooks has been taking more than 30 seconds to load on average - see further details below. Please work on improving your workbook loading performance to make sure the Tableau server stays fast. Thanks!\r\n\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b></li>\r\n<ul><li>Average load time: {{infraction.infraction_value}}</li></ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\n\r\nTableau Warrior Priests (via <i>moniteur</i>)", "infraction_type": "Slow loading workbook", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "SELECT \r\n     -- object info\r\n     w.id AS object_id,\r\n     w.luid,\r\n     w.name AS object_name,\r\n     'Workbook' AS object_type,\r\n     -- p.name as project_name, -- needed?\r\n     -- user info\r\n     su.id AS user_id,\r\n     su.name AS user_name,\r\n     su.email AS user_email,\r\n     su.friendly_name AS user_friendly_name,\r\n     -- infraction info\r\n     c.show_count,\r\n     c.avg_show_time,\r\n     c.load_count,\r\n     c.avg_load_time,\r\n     c.avg_load_time AS infraction_value,\r\n     -- _v.name as view_name,  -- needed? \r\n     timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n     ' ' AS review_by\r\n FROM (\r\n     SELECT hr.currentsheet, \r\n         hr.site_id,\r\n         COUNT(CASE WHEN hr.action='show' THEN 1 \r\n             ELSE NULL END) AS show_count,\r\n         AVG(CASE WHEN hr.action='show' THEN (hr.completed_at - hr.created_at)\r\n             ELSE NULL END) AS avg_show_time,\r\n         COUNT(CASE WHEN hr.action='bootstrapSession' THEN 1 \r\n             ELSE NULL END) AS load_count,\r\n         AVG(CASE WHEN hr.action='bootstrapSession' THEN (hr.completed_at - hr.created_at)\r\n             ELSE NULL END) AS avg_load_time\r\n     FROM public.http_requests hr\r\n     WHERE hr.created_at > DATE(timezone('UTC', NOW())) - INTERVAL '14 days'\r\n         AND hr.action IN ('show', 'bootstrapSession')\r\n         AND hr.currentsheet IS NOT NULL\r\n         AND hr.vizql_session IS NOT NULL\r\n     GROUP BY hr.currentsheet, site_id\r\n     HAVING AVG(CASE WHEN hr.action='bootstrapSession' THEN (hr.completed_at - hr.created_at)\r\n              ELSE NULL END) > INTERVAL '30 sec'\r\n         AND count(CASE WHEN hr.action='bootstrapSession' THEN 1 \r\n             ELSE NULL END) > 10\r\n      ) c\r\n  JOIN public._views _v ON _v.view_url = c.currentsheet\r\n  JOIN public.workbooks w ON _v.workbook_id = w.id AND c.site_id = w.site_id\r\n  JOIN public._system_users su ON su.id = w.owner_id\r\n --  LIMIT 50\r\n\r\n", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 4}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "This infraction occurs when an object's extract refreshes are taking longer than 60 minutes to run, more than 50% of the time.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}} It looks like in the last 14 days, the data extracts for one or more of your Tableau workbooks/datasources have been taking a long time to refresh -- they have run for more than 60 minutes for at least 50% of the runs. See more details below. Please work on decreasing these data extract run times to keep the Tableau server running fast. Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b> (infraction.object_type)</li>\r\n<ul>\r\n<li>Percent of extracts taking longer than 60 minutes: {{ infraction.infraction_value}}</li>\r\n<li>To view <i>{{infraction.object_name}}</i> in your browser, <a href=\"{{infraction.object_url}}\">click here</a></li>\r\n</ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "infraction_type": "Slow per extract time", "email_count": 1, "enabled": "True", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "-- IN PROGRESS \r\nSELECT \r\n    -- object info\r\n    c.object_id,\r\n    c.luid,\r\n    c.object_name,\r\n    c.object_type,\r\n    c.priority,\r\n    -- user info\r\n    su.id AS user_id,\r\n    su.name AS user_name,\r\n    su.email AS user_email,\r\n    su.friendly_name AS user_friendly_name,\r\n    -- infraction info\r\n    c.violation_count,\r\n    c.total_count,\r\n    c.avg_extract_time,\r\n    c.violation_count*100/c.total_count AS percent_violations,\r\n    c.violation_count*100/c.total_count AS infraction_value,\r\n    timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n    timezone('UTC', CURRENT_TIMESTAMP) AS review_by\r\nFROM (\r\n    SELECT COALESCE(wb.id, ds.id) AS object_id,\r\n        COALESCE(_ds.owner_id, _wb.owner_id) AS owner_id,\r\n        bt.title AS object_name, \r\n        bt.subtitle AS object_type,\r\n        bt.priority AS priority, \r\n        COALESCE(ds.luid, wb.luid) AS luid,\r\n        COUNT( CASE WHEN bt.completed_at - bt.started_at > INTERVAL '60 minutes' THEN bt.id\r\n                  ELSE NULL\r\n               END ) as violation_count,\r\n        COUNT(bt.id) AS total_count,\r\n        AVG(bt.completed_at - bt.started_at) AS avg_extract_time\r\n    FROM public._background_tasks bt\r\n    LEFT OUTER JOIN datasources ds ON ds.name = bt.title AND bt.subtitle LIKE 'Data%'\r\n    LEFT OUTER JOIN _datasources _ds ON _ds.id = ds.id\r\n    LEFT OUTER JOIN workbooks wb ON wb.name = bt.title AND bt.subtitle = 'Workbook'\r\n    LEFT OUTER JOIN _workbooks _wb ON _wb.id = wb.id\r\n    WHERE bt.finish_code = 0 -- completed extract\r\n        AND bt.started_at > DATE(timezone('UTC', NOW())) - INTERVAL '14 days'\r\n    GROUP BY COALESCE(wb.id, ds.id), COALESCE(_ds.owner_id, _wb.owner_id), bt.title, bt.subtitle, bt.priority, \r\n        COALESCE(ds.luid, wb.luid)\r\n    ) c\r\nJOIN public._system_users su ON su.id = c.owner_id\r\nWHERE c.violation_count*100/c.total_count > 50\r\n    AND c.total_count > 10\r\nLIMIT 5", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 5}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "Object's extract refreshes are failing more than 50% of the time.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}} We have some news. It looks like one or more of your Tableau workbooks/datasources have been having data extract failures. See below for more details -- each item below has had a data extract fail more than 50% of the time in the last 14 days. Please investigate these failures to see if you can fix the issue. Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b> (infraction.object_type)</li>\r\n<ul>\r\n<li>Failure rate: {{ infraction.infraction_value}}%</li>\r\n</ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "infraction_type": "Extract refresh failure", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "SELECT \r\n    -- object info\r\n    c.object_id,\r\n    c.luid,\r\n    c.object_name,\r\n    c.object_type,\r\n    c.priority,\r\n    -- user info\r\n    su.id AS user_id,\r\n    su.name AS user_name,\r\n    su.email AS user_email,\r\n    su.friendly_name AS user_friendly_name,\r\n    -- infraction info\r\n    c.failure_count,\r\n    c.total_count,\r\n    c.failure_count*100/c.total_count AS percent_failures,\r\n    c.failure_count*100/c.total_count AS infraction_value,\r\n    timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n    ' ' AS review_by\r\nFROM (\r\n    SELECT COALESCE(wb.id, ds.id) AS object_id,\r\n        COALESCE(_ds.owner_id, _wb.owner_id) AS owner_id,\r\n        bt.title AS object_name, \r\n        bt.subtitle AS object_type,\r\n        bt.priority AS priority, \r\n        COALESCE(ds.luid, wb.luid) AS luid,\r\n        COUNT( CASE WHEN bt.finish_code = 1 THEN bt.id\r\n                  ELSE NULL\r\n               END ) as failure_count,\r\n        COUNT(bt.id) AS total_count\r\n    FROM public._background_tasks bt\r\n    LEFT OUTER JOIN datasources ds ON ds.name = bt.title AND bt.subtitle LIKE 'Data%'\r\n    LEFT OUTER JOIN _datasources _ds ON _ds.id = ds.id\r\n    LEFT OUTER JOIN workbooks wb ON wb.name = bt.title AND bt.subtitle = 'Workbook'\r\n    LEFT OUTER JOIN _workbooks _wb ON _wb.id = wb.id\r\n    WHERE bt.started_at > DATE(timezone('UTC', NOW())) - INTERVAL '14 days'\r\n    GROUP BY COALESCE(wb.id, ds.id), COALESCE(_ds.owner_id, _wb.owner_id), bt.title, bt.subtitle, bt.priority, \r\n        COALESCE(ds.luid, wb.luid)\r\n    ) c\r\nJOIN public._system_users su ON su.id = c.owner_id\r\nWHERE c.failure_count*100/c.total_count > 50\r\n    AND c.total_count > 10\r\n-- LIMIT 10", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 6}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "An object with a priority level of 30 is running extracts for longer than 30 seconds more than 50% of the time.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}}  It looks like in the last 14 days, the data extracts for one or more of your Tableau workbooks/datasources have refreshed a bit slowly -- they have not met our goal of 30 seconds for priority levels <= 30. See below for more details -- each item has taken longer than 30 seconds to refresh more than 50% of the time. We reserve extract priorities <= 30 for time-sensitive extracts that run in 30 seconds or less (to avoid blocking other extracts). Please work on improving the extract run times or adjust the priority level accordingly (according to <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Best+Practices\">guidelines here</a>). Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b> (infraction.object_type)</li>\r\n<ul>\r\n<li>Percent of extracts taking longer than 30 seconds: {{ infraction.infraction_value}}</li>\r\n</ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)\r\n", "infraction_type": "Priority 30 abuse", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "-- IN PROGRESS \r\n SELECT \r\n     -- object info\r\n     c.object_id,\r\n     c.luid,\r\n     c.object_name,\r\n     c.object_type,\r\n     c.priority,\r\n     -- user info\r\n     su.id AS user_id,\r\n     su.name AS user_name,\r\n     su.email AS user_email,\r\n     su.friendly_name AS user_friendly_name,\r\n     -- infraction info\r\n     c.violation_count,\r\n     c.total_count,\r\n     c.avg_extract_time,\r\n     c.violation_count*100/c.total_count AS percent_violations,\r\n     c.violation_count*100/c.total_count AS infraction_value,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS review_by\r\n FROM (\r\n     SELECT COALESCE(wb.id, ds.id) AS object_id,\r\n         COALESCE(_ds.owner_id, _wb.owner_id) AS owner_id,\r\n         bt.title AS object_name, \r\n         bt.subtitle AS object_type,\r\n         bt.priority AS priority, \r\n         COALESCE(ds.luid, wb.luid) AS luid,\r\n         COUNT( CASE WHEN bt.completed_at - bt.started_at > INTERVAL '30 seconds' THEN bt.id\r\n                   ELSE NULL\r\n                END ) as violation_count,\r\n         COUNT(bt.id) AS total_count,\r\n         AVG(bt.completed_at - bt.started_at) AS avg_extract_time\r\n     FROM public._background_tasks bt\r\n     LEFT OUTER JOIN datasources ds ON ds.name = bt.title AND bt.subtitle LIKE 'Data%'\r\n     LEFT OUTER JOIN _datasources _ds ON _ds.id = ds.id\r\n     LEFT OUTER JOIN workbooks wb ON wb.name = bt.title AND bt.subtitle = 'Workbook'\r\n     LEFT OUTER JOIN _workbooks _wb ON _wb.id = wb.id\r\n     WHERE bt.finish_code = 0 -- completed extract\r\n         AND bt.started_at > DATE(timezone('UTC', NOW())) - INTERVAL '14 days'\r\n         AND bt.priority <= 30 \r\n     GROUP BY COALESCE(wb.id, ds.id), COALESCE(_ds.owner_id, _wb.owner_id), bt.title, bt.subtitle, bt.priority, \r\n         COALESCE(ds.luid, wb.luid)\r\n     ) c\r\n JOIN public._system_users su ON su.id = c.owner_id\r\n WHERE c.violation_count*100/c.total_count > 50\r\n     AND c.total_count > 10\r\n -- LIMIT 100", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 7}, {"fields": {"resolved_email_template": "Tempate", "interval": 7, "enable_archive": "False", "description": "An object with a priority level of 40 is running extracts for longer than 180 seconds more than 50% of the time.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}} It looks like in the last 14 days, the data extracts for one or more of your Tableau workbooks/datasources have refreshed a bit slowly -- they have not met our goal of 180 seconds for priority levels <= 40. See below for more details -- each item has taken longer than 180 seconds to refresh more than 50% of the time. We reserve extract priority 40 for extracts that run in 180 seconds or less (to avoid blocking faster extracts). Please work on improving the extract run times or adjust the priority level accordingly (according to <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Best+Practices\">guidelines here</a>). Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b> (infraction.object_type)</li>\r\n<ul>\r\n<li>Percent of extracts taking longer than 180 seconds: {{ infraction.infraction_value}}</li>\r\n</ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "infraction_type": "Priority 40 abuse", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Tempate", "search_query": "SELECT \r\n     -- object info\r\n     c.object_id,\r\n     c.luid,\r\n     c.object_name,\r\n     c.object_type,\r\n     c.priority,\r\n     -- user info\r\n     su.id AS user_id,\r\n     su.name AS user_name,\r\n     su.email AS user_email,\r\n     su.friendly_name AS user_friendly_name,\r\n     -- infraction info\r\n     c.violation_count,\r\n     c.total_count,\r\n     c.avg_extract_time,\r\n     c.violation_count*100/c.total_count AS percent_violations,\r\n     c.violation_count*100/c.total_count AS infraction_value,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS review_by\r\n FROM (\r\n     SELECT COALESCE(wb.id, ds.id) AS object_id,\r\n         COALESCE(_ds.owner_id, _wb.owner_id) AS owner_id,\r\n         bt.title AS object_name, \r\n         bt.subtitle AS object_type,\r\n         bt.priority AS priority, \r\n         COALESCE(ds.luid, wb.luid) AS luid,\r\n         COUNT( CASE WHEN bt.completed_at - bt.started_at > INTERVAL '180 seconds' THEN bt.id\r\n                   ELSE NULL\r\n                END ) as violation_count,\r\n         COUNT(bt.id) AS total_count,\r\n         AVG(bt.completed_at - bt.started_at) AS avg_extract_time\r\n     FROM public._background_tasks bt\r\n     LEFT OUTER JOIN datasources ds ON ds.name = bt.title AND bt.subtitle LIKE 'Data%'\r\n     LEFT OUTER JOIN _datasources _ds ON _ds.id = ds.id\r\n     LEFT OUTER JOIN workbooks wb ON wb.name = bt.title AND bt.subtitle = 'Workbook'\r\n     LEFT OUTER JOIN _workbooks _wb ON _wb.id = wb.id\r\n     WHERE bt.finish_code = 0 -- completed extract\r\n         AND bt.started_at > DATE(timezone('UTC', NOW())) - INTERVAL '14 days'\r\n         AND bt.priority > 30 AND bt.priority <= 40\r\n     GROUP BY COALESCE(wb.id, ds.id), COALESCE(_ds.owner_id, _wb.owner_id), bt.title, bt.subtitle, bt.priority, \r\n         COALESCE(ds.luid, wb.luid)\r\n     ) c\r\n JOIN public._system_users su ON su.id = c.owner_id\r\n WHERE c.violation_count*100/c.total_count > 50\r\n     AND c.total_count > 10\r\n -- LIMIT 100", "archive_notice_template": "Tempate"}, "model": "schema.infractiontype", "pk": 8}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "An object with a priority level of 50 is running extracts for longer than 10 minutes more than 50% of the time.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}}  Hello! It looks like in the last 14 days, the data extracts for one or more of your Tableau workbooks/datasources have refreshed a bit slowly -- they have not met our goal of 10 minutes for priority levels <= 50. See below for more details -- each item has taken longer than 10 minutes to refresh more than 50% of the time. We reserve extract priority 50 for extracts that run in 10 minutes or less (to avoid blocking faster extracts). Please work on improving the extract run times or adjust the priority level accordingly (according to <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Best+Practices\">guidelines here</a>). Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b> (infraction.object_type)</li>\r\n<ul>\r\n<li>Percent of extracts taking longer than 10 minutes: {{ infraction.infraction_value}}</li>\r\n</ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)\r\n", "infraction_type": "Priority 50 abuse", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "SELECT \r\n     -- object info\r\n     c.object_id,\r\n     c.luid,\r\n     c.object_name,\r\n     c.object_type,\r\n     c.priority,\r\n     -- user info\r\n     su.id AS user_id,\r\n     su.name AS user_name,\r\n     su.email AS user_email,\r\n     su.friendly_name AS user_friendly_name,\r\n     -- infraction info\r\n     c.violation_count,\r\n     c.total_count,\r\n     c.avg_extract_time,\r\n     c.violation_count*100/c.total_count AS percent_violations,\r\n     c.violation_count*100/c.total_count AS infraction_value,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS review_by\r\n FROM (\r\n     SELECT COALESCE(wb.id, ds.id) AS object_id,\r\n         COALESCE(_ds.owner_id, _wb.owner_id) AS owner_id,\r\n         bt.title AS object_name, \r\n         bt.subtitle AS object_type,\r\n         bt.priority AS priority, \r\n         COALESCE(ds.luid, wb.luid) AS luid,\r\n         COUNT( CASE WHEN bt.completed_at - bt.started_at > INTERVAL '10 minutes' THEN bt.id\r\n                   ELSE NULL\r\n                END ) as violation_count,\r\n         COUNT(bt.id) AS total_count,\r\n         AVG(bt.completed_at - bt.started_at) AS avg_extract_time\r\n     FROM public._background_tasks bt\r\n     LEFT OUTER JOIN datasources ds ON ds.name = bt.title AND bt.subtitle LIKE 'Data%'\r\n     LEFT OUTER JOIN _datasources _ds ON _ds.id = ds.id\r\n     LEFT OUTER JOIN workbooks wb ON wb.name = bt.title AND bt.subtitle = 'Workbook'\r\n     LEFT OUTER JOIN _workbooks _wb ON _wb.id = wb.id\r\n     WHERE bt.finish_code = 0 -- completed extract\r\n         AND bt.started_at > DATE(timezone('UTC', NOW())) - INTERVAL '14 days'\r\n         AND bt.priority > 40 AND bt.priority <= 50\r\n     GROUP BY COALESCE(wb.id, ds.id), COALESCE(_ds.owner_id, _wb.owner_id), bt.title, bt.subtitle, bt.priority, \r\n         COALESCE(ds.luid, wb.luid)\r\n     ) c\r\n JOIN public._system_users su ON su.id = c.owner_id\r\n WHERE c.violation_count*100/c.total_count > 50\r\n     AND c.total_count > 10\r\n -- LIMIT 100", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 9}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "An object with a priority level of 60 is running extracts for longer than 30 minutes more than 50% of the time.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}} It looks like in the last 14 days, the data extracts for one or more of your Tableau workbooks/datasources have been refreshing really slowly! They have taken more than 30 minutes to complete at least 50% of the time. Please work on improving the extract run times to keep the Tableau server running fast. Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b> (infraction.object_type)</li>\r\n<ul>\r\n<li>Percent of extracts taking longer than 30 minutes: {{ infraction.infraction_value}}</li>\r\n</ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "infraction_type": "Priority 60 abuse", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "SELECT \r\n     -- object info\r\n     c.object_id,\r\n     c.luid,\r\n     c.object_name,\r\n     c.object_type,\r\n     c.priority,\r\n     -- user info\r\n     su.id AS user_id,\r\n     su.name AS user_name,\r\n     su.email AS user_email,\r\n     su.friendly_name AS user_friendly_name,\r\n     -- infraction info\r\n     c.violation_count,\r\n     c.total_count,\r\n     c.avg_extract_time,\r\n     c.violation_count*100/c.total_count AS percent_violations,\r\n     c.violation_count*100/c.total_count AS infraction_value,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS review_by\r\n FROM (\r\n     SELECT COALESCE(wb.id, ds.id) AS object_id,\r\n         COALESCE(_ds.owner_id, _wb.owner_id) AS owner_id,\r\n         bt.title AS object_name, \r\n         bt.subtitle AS object_type,\r\n         bt.priority AS priority, \r\n         COALESCE(ds.luid, wb.luid) AS luid,\r\n         COUNT( CASE WHEN bt.completed_at - bt.started_at > INTERVAL '30 minutes' THEN bt.id\r\n                   ELSE NULL\r\n                END ) as violation_count,\r\n         COUNT(bt.id) AS total_count,\r\n         AVG(bt.completed_at - bt.started_at) AS avg_extract_time\r\n     FROM public._background_tasks bt\r\n     LEFT OUTER JOIN datasources ds ON ds.name = bt.title AND bt.subtitle LIKE 'Data%'\r\n     LEFT OUTER JOIN _datasources _ds ON _ds.id = ds.id\r\n     LEFT OUTER JOIN workbooks wb ON wb.name = bt.title AND bt.subtitle = 'Workbook'\r\n     LEFT OUTER JOIN _workbooks _wb ON _wb.id = wb.id\r\n     WHERE bt.finish_code = 0 -- completed extract\r\n         AND bt.started_at > DATE(timezone('UTC', NOW())) - INTERVAL '14 days'\r\n         AND bt.priority > 50\r\n     GROUP BY COALESCE(wb.id, ds.id), COALESCE(_ds.owner_id, _wb.owner_id), bt.title, bt.subtitle, bt.priority, \r\n         COALESCE(ds.luid, wb.luid)\r\n     ) c\r\n JOIN public._system_users su ON su.id = c.owner_id\r\n WHERE c.violation_count*100/c.total_count > 50\r\n     AND c.total_count > 10\r\n -- LIMIT 100", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 10}, {"fields": {"resolved_email_template": "Template", "interval": 7, "enable_archive": "False", "description": "An object's extracts run for longer than 4 hours a day, more than 50% of the time.", "email_template": "{{user_name}},\r\n\r\n<br><br>\r\n\r\n{{greeting}} It looks like one or more of your Tableau workbooks/datasources have been spending a lot of time refreshing data extracts. See below for more details -- each item has had an extract running for more than 4 hours/day on average over the last 14 days. Please work on descreasing this cumulative extract refresh time to keep the Tableau server running fast. Thanks!\r\n<br><br>\r\nTo learn more about the Tableau monitoring project, <a href=\"https://confluence.teslamotors.com/display/DATA/Tableau+Server+monitoring\">click here</a>.\r\n<br><br>\r\n\r\n<ul>\r\n{% for infraction in infractions %}\r\n<li><b>{{ infraction.object_name }}</b> (infraction.object_type)</li>\r\n<ul>\r\n<li>Average minutes per day: {{ infraction.infraction_value}}</li>\r\n</ul>\r\n{% endfor %}\r\n</ul>\r\n\r\n<br><br>\r\nTableau Warrior Priests (via <i>moniteur</i>)", "infraction_type": "Slow daily extract time", "email_count": 1, "enabled": "False", "tableau_site_id": 0, "archive_email_template": "Template", "search_query": "SELECT \r\n     -- object info\r\n     title as object_name, \r\n     subtitle AS object_type,\r\n     COALESCE(ds.id, wb.id) AS object_id,\r\n     COALESCE(ds.luid, wb.luid) AS luid,\r\n     -- user info\r\n     su.name AS user_name,\r\n     su.id AS user_id,\r\n     su.friendly_name AS user_friendly_name,\r\n     su.email AS user_email,\r\n     -- infraction info\r\n     AVG(time_per_day) AS avg_time_per_day,\r\n     DATE_PART('hour', AVG(time_per_day))*60 + DATE_PART('minute', AVG(time_per_day)) AS infraction_value,\r\n     timezone('UTC', CURRENT_TIMESTAMP) AS date_added,\r\n     ' ' AS review_by\r\n  FROM (\r\n     -- query daily total extract time per object\r\n     SELECT title, subtitle, DATE(timezone('UTC', started_at)) as extract_date,  SUM(completed_at - started_at) AS time_per_day\r\n     FROM _background_tasks\r\n     WHERE started_at > DATE(timezone('UTC', NOW()) - INTERVAL '14 days')\r\n     GROUP BY title, subtitle, extract_date\r\n     ) AS time_summary\r\n LEFT OUTER JOIN datasources ds ON ds.name = title AND subtitle LIKE 'Data%'\r\n LEFT OUTER JOIN _datasources _ds ON _ds.id = ds.id \r\n LEFT OUTER JOIN workbooks wb ON wb.name = title AND subtitle = 'Workbook'\r\n LEFT OUTER JOIN _workbooks _wb ON _wb.id = wb.id \r\n JOIN _system_users su ON su.id = COALESCE(_ds.owner_id, _wb.owner_id)\r\n GROUP BY title, subtitle, COALESCE(ds.luid, wb.luid), user_name, su.email, user_id, COALESCE(ds.id, wb.id), su.friendly_name, review_by\r\n HAVING AVG(time_per_day) > INTERVAL '4 hours'\r\n -- LIMIT 10", "archive_notice_template": "Template"}, "model": "schema.infractiontype", "pk": 11}]